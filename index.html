<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Clock Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen">
  <!-- Login -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
      <div class="text-center mb-8">
        <div class="w-20 h-20 gradient-bg rounded-2xl flex items-center justify-center text-4xl mx-auto mb-4">â°</div>
        <h1 class="text-3xl font-bold text-slate-800">Time Clock Pro</h1>
        <p class="text-slate-500 mt-2">Sign in to clock in</p>
      </div>
      <div id="loginForm">
        <input type="text" id="username" placeholder="Username" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl mb-4">
        <input type="password" id="password" placeholder="Password" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl mb-6">
        <button onclick="login()" class="w-full py-3 gradient-bg text-white text-lg font-bold rounded-xl">Sign In</button>
        <p id="loginError" class="text-red-500 text-center mt-4 hidden"></p>
      </div>
      <div class="mt-6 text-center">
        <button onclick="showRegister()" class="text-indigo-600 font-medium">Register</button>
      </div>
      <div id="registerForm" class="hidden">
        <input type="text" id="regUsername" placeholder="Username" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl mb-4">
        <input type="password" id="regPassword" placeholder="Password" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl mb-4">
        <input type="text" id="regName" placeholder="Full Name" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl mb-6">
        <button onclick="register()" class="w-full py-3 bg-green-500 text-white text-lg font-bold rounded-xl">Register</button>
        <p id="regError" class="text-red-500 text-center mt-4 hidden"></p>
        <button onclick="showLogin()" class="w-full mt-4 text-slate-500">Back</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="appScreen" class="hidden">
    <nav class="bg-white shadow-lg border-b">
      <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center text-xl">â°</div>
          <span class="text-xl font-bold text-slate-800">Time Clock Pro</span>
        </div>
        <div class="flex items-center gap-4">
          <span id="userDisplay" class="font-semibold text-slate-700"></span>
          <button onclick="logout()" class="text-red-500 font-medium">Logout</button>
        </div>
      </div>
    </nav>

    <div class="max-w-4xl mx-auto p-6">
      <!-- Tab Navigation -->
      <div class="flex gap-2 mb-6 overflow-x-auto">
        <button onclick="showView('clock')" class="nav-btn px-5 py-2.5 rounded-xl font-medium bg-indigo-500 text-white">â±ï¸ Clock</button>
        <button onclick="showView('whosIn')" class="nav-btn px-5 py-2.5 rounded-xl font-medium bg-slate-100">ğŸ‘¥ Who's In</button>
        <button onclick="showView('schedule')" class="nav-btn px-5 py-2.5 rounded-xl font-medium bg-slate-100">ğŸ“… Schedule</button>
        <button onclick="showView('reports')" class="nav-btn px-5 py-2.5 rounded-xl font-medium bg-slate-100">ğŸ“Š Reports</button>
      </div>

      <!-- CLOCK VIEW -->
      <div id="view-clock" class="view">
        <div class="grid md:grid-cols-2 gap-6">
          <!-- Main Clock -->
          <div class="bg-white rounded-3xl shadow-xl p-8 text-center">
            <div class="mb-4">
              <div id="currentTime" class="text-5xl font-bold text-slate-800"></div>
              <div id="currentDate" class="text-lg text-slate-500"></div>
            </div>
            
            <div id="statusBadge" class="inline-block px-8 py-4 rounded-2xl text-2xl font-bold mb-4 bg-slate-100 text-slate-600">Not Clocked In</div>
            
            <div id="timerDisplay" class="hidden mb-4">
              <p id="sessionType" class="text-slate-500 text-lg">Working</p>
              <p id="timer" class="text-6xl font-bold text-indigo-600">00:00:00</p>
            </div>
            
            <button id="clockBtn" onclick="handleClock()" class="px-10 py-5 gradient-bg text-white text-2xl font-bold rounded-2xl shadow-lg w-full">
              Clock In
            </button>
            <button id="breakBtn" onclick="toggleBreak()" class="hidden mt-2 px-6 py-3 bg-yellow-500 text-white rounded-xl w-full">
              Take Break
            </button>
            
            <p id="debugInfo" class="text-xs text-slate-400 mt-4"></p>
          </div>

          <!-- Stats -->
          <div class="space-y-4">
            <div class="bg-white rounded-2xl shadow-lg p-6">
              <h3 class="font-bold text-slate-700 mb-4">ğŸ“Š My Hours</h3>
              <div class="space-y-3">
                <div class="flex justify-between p-3 bg-blue-50 rounded-xl"><span>Today</span><span class="font-bold text-blue-600" id="myTodayHours">0h 0m</span></div>
                <div class="flex justify-between p-3 bg-purple-50 rounded-xl"><span>This Week</span><span class="font-bold text-purple-600" id="myWeekHours">0h 0m</span></div>
                <div class="flex justify-between p-3 bg-orange-50 rounded-xl"><span>This Period</span><span class="font-bold text-orange-600" id="myMonthHours">0h 0m</span></div>
                <div class="flex justify-between p-3 bg-red-50 rounded-xl"><span>Overtime</span><span class="font-bold text-red-600" id="myOvertime">0h 0m</span></div>
              </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg p-6">
              <h3 class="font-bold text-slate-700 mb-4">ğŸ“‹ Recent Entries</h3>
              <div id="myEntries" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- WHO'S IN -->
      <div id="view-whosIn" class="view hidden">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
          <div class="px-6 py-4 gradient-bg"><h2 class="text-xl font-bold text-white">ğŸ‘¥ Who's Working Now</h2></div>
          <div id="whosInList" class="divide-y"></div>
        </div>
      </div>

      <!-- SCHEDULE -->
      <div id="view-schedule" class="view hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">ğŸ“… Weekly Schedule</h2>
            <div class="flex gap-2 mb-4"><button onclick="changeWeek(-1)" class="px-3 py-2 bg-slate-100 rounded">â†</button><span id="weekRange" class="flex-1 text-center py-2 bg-slate-100 rounded"></span><button onclick="changeWeek(1)" class="px-3 py-2 bg-slate-100 rounded">â†’</button></div>
            <div id="scheduleGrid" class="grid grid-cols-7 gap-2"></div>
          </div>
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4">ğŸ–ï¸ Request Time Off</h2>
            <input type="date" id="requestDate" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl mb-3">
            <select id="requestType" class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl mb-3">
              <option value="vacation">Vacation</option><option value="sick">Sick Day</option><option value="personal">Personal</option>
            </select>
            <button onclick="submitRequest()" class="w-full py-3 gradient-bg text-white font-bold rounded-xl mb-4">Submit</button>
            <div id="myRequests" class="space-y-2 max-h-48 overflow-y-auto"></div>
          </div>
        </div>
      </div>

      <!-- REPORTS -->
      <div id="view-reports" class="view hidden">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
          <div class="px-6 py-4 gradient-bg flex justify-between items-center">
            <h2 class="text-xl font-bold text-white">ğŸ“Š Hours Report</h2>
            <button onclick="exportCSV()" class="px-4 py-2 bg-white/20 text-white rounded-lg">ğŸ“¥ Export</button>
          </div>
          <div class="p-6">
            <div class="flex gap-4 mb-6">
              <select id="reportPeriod" class="px-4 py-3 border-2 border-slate-200 rounded-xl">
                <option value="today">Today</option><option value="week" selected>This Week</option><option value="month">This Month</option>
              </select>
              <button onclick="loadReport()" class="px-6 py-3 gradient-bg text-white font-bold rounded-xl">Generate</button>
            </div>
            <table class="w-full">
              <thead class="bg-slate-50"><tr><th class="px-4 py-3 text-left">Employee</th><th class="px-4 py-3 text-right">Hours</th><th class="px-4 py-3 text-right">Breaks</th></tr></thead>
              <tbody id="reportBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
const SUPABASE_URL = 'https://xybsaxjbtbpxpqwpbvmm.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5YnNheGpidGJweHBxd3Bidm1tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MzMyMjAsImV4cCI6MjA4NjQwOTIyMH0.0tNbX0yGx8BTM67aGDWObj21JG_rfMJ6jOKIIS6uYsE';

let currentUser = null, currentEntry = null, timerInterval = null, weekOffset = 0;

const savedUser = localStorage.getItem('timeclock_user');
if (savedUser) { 
  try {
    currentUser = JSON.parse(savedUser);
    console.log('Loaded user:', currentUser);
    showApp(); 
  } catch(e) {
    console.error('Error loading user:', e);
    localStorage.removeItem('timeclock_user');
  }
}

function updateClock() {
  const now = new Date();
  document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}
setInterval(updateClock, 1000);
updateClock();

function showLogin() { 
  document.getElementById('loginScreen').classList.remove('hidden'); 
  document.getElementById('appScreen').classList.add('hidden'); 
  document.getElementById('loginForm').classList.remove('hidden');
  document.getElementById('registerForm').classList.add('hidden');
}
function showRegister() { document.getElementById('loginForm').classList.add('hidden'); document.getElementById('registerForm').classList.remove('hidden'); }

async function login() {
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value;
  if (!u || !p) return showError('Enter username and password');
  
  console.log('Logging in:', u);
  const data = await supabaseFetch('users?username=eq.' + encodeURIComponent(u) + '&password=eq.' + encodeURIComponent(p) + '&limit=1');
  console.log('Login response:', data);
  
  if (!data || data.length === 0) return showError('Invalid credentials');
  
  currentUser = data[0];
  console.log('User logged in:', currentUser);
  localStorage.setItem('timeclock_user', JSON.stringify(currentUser)); 
  showApp();
}

async function register() {
  const u = document.getElementById('regUsername').value.trim();
  const p = document.getElementById('regPassword').value;
  const n = document.getElementById('regName').value.trim();
  if (!u || !p || !n) return showRegError('Fill all fields');
  
  console.log('Registering:', u, n);
  const existing = await supabaseFetch('users?username=eq.' + encodeURIComponent(u) + '&limit=1');
  if (existing && existing.length > 0) return showRegError('Username taken');
  
  const result = await supabasePost('users', { username: u, password: p, name: n, role: 'employee' });
  console.log('Register result:', result);
  
  // Fetch the created user to get the ID
  const newUser = await supabaseFetch('users?username=eq.' + encodeURIComponent(u) + '&limit=1');
  console.log('New user:', newUser);
  
  if (newUser && newUser.length > 0) {
    currentUser = newUser[0];
    localStorage.setItem('timeclock_user', JSON.stringify(currentUser)); 
    showApp();
  } else {
    showRegError('Registration failed');
  }
}

function logout() { 
  localStorage.removeItem('timeclock_user'); 
  currentUser = null; 
  stopTimer(); 
  showLogin(); 
}
function showError(msg) { const el = document.getElementById('loginError'); el.textContent = msg; el.classList.remove('hidden'); }
function showRegError(msg) { const el = document.getElementById('regError'); el.textContent = msg; el.classList.remove('hidden'); }

function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('appScreen').classList.remove('hidden');
  document.getElementById('userDisplay').textContent = currentUser?.name;
  document.getElementById('debugInfo').textContent = 'User ID: ' + (currentUser?.id || 'None');
  showView('clock');
}

function showView(viewName) {
  document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
  document.getElementById('view-' + viewName).classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(btn => btn.className = 'nav-btn px-5 py-2.5 rounded-xl font-medium bg-slate-100');
  event?.target?.classList.add('bg-indigo-500', 'text-white');
  if (viewName === 'clock') loadTimeClock();
  if (viewName === 'whosIn') loadWhosIn();
  if (viewName === 'schedule') loadSchedule();
  if (viewName === 'reports') loadReport();
}

async function loadTimeClock() {
  if (!currentUser?.id) {
    console.error('No user ID');
    return;
  }
  
  console.log('Loading clock for user:', currentUser.id);
  
  // Check for open entry
  const { data, error } = await supabaseFetch('time_entries?user_id=eq.' + currentUser.id + '&clock_out=is.null&order=clock_in.desc&limit=1');
  console.log('Open entries:', data, error);
  
  if (data && data.length > 0) { 
    currentEntry = data[0]; 
    console.log('Found open entry:', currentEntry);
    updateClockUI(true, currentEntry.is_break); 
    startTimer(currentEntry.clock_in); 
  } else {
    currentEntry = null;
    updateClockUI(false, false); 
  }
  
  // Load stats
  const today = new Date(); today.setHours(0,0,0,0);
  const weekStart = new Date(today); weekStart.setDate(today.getDate() - today.getDay() + 1); weekStart.setHours(0,0,0,0);
  const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
  
  const [tD, wD, mD] = await Promise.all([
    supabaseFetch('time_entries?user_id=eq.' + currentUser.id + '&clock_in=gte.' + today.toISOString()),
    supabaseFetch('time_entries?user_id=eq.' + currentUser.id + '&clock_in=gte.' + weekStart.toISOString()),
    supabaseFetch('time_entries?user_id=eq.' + currentUser.id + '&clock_in=gte.' + monthStart.toISOString())
  ]);
  
  console.log('Stats:', { today: tD, week: wD, month: mD });
  
  const todayHours = calcHoursMs(tD||[]);
  const weekHours = calcHoursMs(wD||[]);
  const monthHours = calcHoursMs(mD||[]);
  const overtime = Math.max(0, weekHours - 40*3600000);
  
  document.getElementById('myTodayHours').innerHTML = formatHours(todayHours);
  document.getElementById('myWeekHours').innerHTML = formatHours(weekHours);
  document.getElementById('myMonthHours').innerHTML = formatHours(monthHours);
  document.getElementById('myOvertime').innerHTML = formatHours(overtime);
  
  // Recent entries
  const weekEntries = await supabaseFetch('time_entries?user_id=eq.' + currentUser.id + '&clock_in=gte.' + weekStart.toISOString() + '&order=clock_in.desc&limit=10');
  console.log('Recent entries:', weekEntries);
  document.getElementById('myEntries').innerHTML = (weekEntries||[]).map(e => { 
    const d = e.clock_out ? new Date(e.clock_out)-new Date(e.clock_in) : new Date()-new Date(e.clock_in); 
    return '<div class="p-3 flex justify-between bg-slate-50 rounded-lg"><div><p class="font-medium ' + (e.is_break?'text-yellow-600':'text-slate-700') + '">' + (e.is_break?'Break':'Work') + '</p><p class="text-xs text-slate-400">' + formatDate(e.clock_in) + '</p></div><span class="font-bold">' + formatDuration(d) + '</span></div>'; 
  }).join('')||'<p class="text-slate-400 text-center py-4">No entries</p>';
}

async function handleClock() {
  console.log('Clock action. Current entry:', currentEntry, 'User:', currentUser?.id);
  
  if (currentEntry) { 
    // Clock out
    console.log('Clocking out entry:', currentEntry.id);
    await supabasePatch('time_entries?id=eq.' + currentEntry.id, {clock_out: new Date().toISOString()}); 
    currentEntry = null; 
    stopTimer(); 
    updateClockUI(false, false); 
    loadTimeClock();
  } else { 
    // Clock in
    if (!currentUser?.id) {
      alert('Error: Not logged in properly');
      return;
    }
    console.log('Clocking in user:', currentUser.id, currentUser.name);
    
    const entryData = {
      user_id: currentUser.id, 
      employee_name: currentUser.name, 
      clock_in: new Date().toISOString(), 
      is_break: false
    };
    console.log('Creating entry:', entryData);
    
    const result = await supabasePost('time_entries', entryData);
    console.log('Clock in result:', result);
    
    // Fetch the newly created entry and update UI immediately
    const { data } = await supabaseFetch('time_entries?user_id=eq.' + currentUser.id + '&clock_out=is.null&order=clock_in.desc&limit=1');
    console.log('New open entries:', data);
    
    if (data && data.length > 0) { 
      currentEntry = data[0]; 
      console.log('Setting currentEntry:', currentEntry);
    }
    
    // Update UI immediately after getting the entry
    updateClockUI(!!currentEntry, currentEntry?.is_break || false);
    if (currentEntry) {
      startTimer(currentEntry.clock_in);
    }
  }
}

async function toggleBreak() {
  if (!currentEntry) return;
  await supabasePatch('time_entries?id=eq.' + currentEntry.id, {clock_out: new Date().toISOString()});
  const isEnding = currentEntry.is_break;
  await supabasePost('time_entries', {user_id: currentUser.id, employee_name: currentUser.name, clock_in: new Date().toISOString(), is_break: !isEnding});
  loadTimeClock();
}

function updateClockUI(clocked, isBreak) {
  const badge = document.getElementById('statusBadge'), timer = document.getElementById('timerDisplay'), btn = document.getElementById('clockBtn'), breakBtn = document.getElementById('breakBtn');
  if (clocked) {
    if (isBreak) { 
      badge.textContent='On Break'; badge.className='inline-block px-8 py-4 rounded-2xl text-2xl font-bold mb-4 bg-yellow-100 text-yellow-700'; 
      btn.textContent='End Break'; btn.className='px-10 py-5 bg-orange-500 text-white text-2xl font-bold rounded-2xl w-full'; 
      breakBtn.classList.add('hidden'); 
    } else { 
      badge.textContent='Working'; badge.className='inline-block px-8 py-4 rounded-2xl text-2xl font-bold mb-4 bg-green-100 text-green-700'; 
      btn.textContent='Clock Out'; btn.className='px-10 py-5 bg-red-500 text-white text-2xl font-bold rounded-2xl w-full'; 
      breakBtn.classList.remove('hidden'); 
    }
    document.getElementById('sessionType').textContent = isBreak ? 'On Break' : 'Working';
    timer.classList.remove('hidden');
  } else { 
    badge.textContent='Not Clocked In'; badge.className='inline-block px-8 py-4 rounded-2xl text-2xl font-bold mb-4 bg-slate-100 text-slate-600'; 
    timer.classList.add('hidden'); 
    btn.textContent='Clock In'; btn.className='px-10 py-5 gradient-bg text-white text-2xl font-bold rounded-2xl w-full shadow-lg'; 
    breakBtn.classList.add('hidden'); 
  }
}

function startTimer(clockIn) {
  const start = new Date(clockIn);
  function u() { const diff=new Date()-start, h=Math.floor(diff/3600000), m=Math.floor((diff%3600000)/60000), s=Math.floor((diff%60000)/1000); document.getElementById('timer').textContent = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0'); }
  u(); timerInterval = setInterval(u, 1000);
}
function stopTimer() { if(timerInterval) clearInterval(timerInterval); }

async function loadWhosIn() {
  const { data } = await supabaseFetch('time_entries?clock_out=is.null&order=clock_in.desc');
  const now = new Date();
  document.getElementById('whosInList').innerHTML = (data||[]).map(e => {
    const elapsed = new Date(now) - new Date(e.clock_in);
    return '<div class="p-4 flex items-center justify-between"><div class="flex items-center gap-4"><div class="w-12 h-12 gradient-bg rounded-full flex items-center justify-center text-white font-bold">' + e.employee_name.charAt(0) + '</div><div><p class="font-bold">' + e.employee_name + '</p><p class="text-sm text-slate-500">In: ' + formatTime(e.clock_in) + '</p></div></div><div class="text-right"><span class="text-xl font-bold text-green-600">' + formatDuration(elapsed) + '</span></div></div>';
  }).join('') || '<div class="p-8 text-center text-slate-400">No one is working</div>';
}

function changeWeek(d) { weekOffset += d; loadSchedule(); }
async function loadSchedule() {
  const today = new Date(), ws = new Date(today); ws.setDate(today.getDate() - today.getDay() + weekOffset*7); ws.setHours(0,0,0,0);
  const we = new Date(ws); we.setDate(ws.getDate() + 6);
  document.getElementById('weekRange').textContent = ws.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' - ' + we.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  const entries = await supabaseFetch('time_entries?clock_in=gte.' + ws.toISOString() + '&clock_in=lte.' + we.toISOString());
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  document.getElementById('scheduleGrid').innerHTML = days.map((d,i) => { 
    const dt = new Date(ws); dt.setDate(ws.getDate()+i); 
    const dayEntries = (entries||[]).filter(e => new Date(e.clock_in).toDateString() === dt.toDateString() && !e.is_break); 
    return '<div class="p-3 bg-slate-50 rounded-xl text-center"><p class="font-bold text-sm">' + d + '</p><p class="text-xs text-slate-500">' + dt.getDate() + '</p>' + (dayEntries.length ? '<div class="mt-2 pt-2 border-t"><p class="text-xs font-bold text-indigo-600">' + dayEntries.length + '</p></div>' : '') + '</div>'; 
  }).join('');
  loadMyRequests();
}

async function submitRequest() {
  const date = document.getElementById('requestDate').value;
  const type = document.getElementById('requestType').value;
  if(!date) return alert('Select a date');
  await supabasePost('time_requests', {user_id: currentUser.id, employee_name: currentUser.name, request_date: date, request_type: type, status: 'pending'});
  alert('Request submitted!'); document.getElementById('requestDate').value = ''; loadMyRequests();
}

async function loadMyRequests() {
  const requests = await supabaseFetch('time_requests?user_id=eq.' + currentUser.id + '&order=created_at.desc&limit=10');
  document.getElementById('myRequests').innerHTML = (requests||[]).length ? requests.map(r => '<div class="p-3 bg-slate-50 rounded-lg flex justify-between"><div><p class="font-medium capitalize">' + r.request_type + '</p><p class="text-sm text-slate-500">' + r.request_date + '</p></div><span class="px-3 py-1 rounded-full text-sm ' + (r.status==='pending'?'bg-yellow-100 text-yellow-700':r.status==='approved'?'bg-green-100 text-green-700':'bg-red-100 text-red-700') + '">' + r.status + '</span></div>').join('') : '<p class="text-slate-400">No requests</p>';
}

async function loadReport() {
  const period = document.getElementById('reportPeriod').value;
  const today = new Date(); today.setHours(0,0,0,0);
  let start, end;
  if(period==='today'){ start = today; end = today; }
  else if(period==='week'){ start = new Date(today); start.setDate(today.getDate()-today.getDay()+1); end = new Date(start); end.setDate(start.getDate()+6); }
  else { start = new Date(today.getFullYear(), today.getMonth(), 1); end = new Date(today.getFullYear(), today.getMonth()+1, 0); }
  
  const entries = await supabaseFetch('time_entries?clock_in=gte.' + start.toISOString() + '&clock_in=lte.' + end.toISOString());
  
  const grouped = {};
  (entries||[]).forEach(e => {
    if(!grouped[e.employee_name]) grouped[e.employee_name] = {work:0, brk:0};
    if(e.clock_out){
      const ms = new Date(e.clock_out)-new Date(e.clock_in);
      if(e.is_break) grouped[e.employee_name].brk += ms;
      else grouped[e.employee_name].work += ms;
    }
  });
  
  document.getElementById('reportBody').innerHTML = Object.entries(grouped).map(([name,data]) => '<tr><td class="px-4 py-3 font-medium">' + name + '</td><td class="px-4 py-3 text-right">' + formatHours(data.work) + '</td><td class="px-4 py-3 text-right">' + formatHours(data.brk) + '</td></tr>').join('') || '<tr><td colspan="3" class="px-4 py-8 text-center text-slate-400">No data</td></tr>';
}

function exportCSV() {
  let csv = 'Employee,Hours,Breaks\n';
  document.querySelectorAll('#reportBody tr').forEach(tr => {
    const cells = tr.querySelectorAll('td');
    if(cells.length >= 3) csv += cells[0].textContent + ',' + cells[1].textContent + ',' + cells[2].textContent + '\n';
  });
  const blob = new Blob([csv], {type: 'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'hours_report.csv'; a.click();
}

function supabaseFetch(q) { 
  return fetch(SUPABASE_URL + '/rest/v1/' + q, {
    headers: { apikey: SUPABASE_KEY, Authorization: 'Bearer ' + SUPABASE_KEY }
  }).then(r => r.json()).catch(e => { console.error('Fetch error:', e); return []; }); 
}

function supabasePost(t,d) { 
  return fetch(SUPABASE_URL + '/rest/v1/' + t, {
    method: 'POST',
    headers: { apikey: SUPABASE_KEY, Authorization: 'Bearer '+SUPABASE_KEY, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
    body: JSON.stringify(d)
  }).then(r => r.json()).catch(e => { console.error('Post error:', e); return {}; }); 
}

function supabasePatch(q,d) { 
  return fetch(SUPABASE_URL + '/rest/v1/' + q, {
    method: 'PATCH',
    headers: { apikey: SUPABASE_KEY, Authorization: 'Bearer '+SUPABASE_KEY, 'Content-Type': 'application/json' },
    body: JSON.stringify(d)
  }).then(r => r.ok ? r.json() : r.text().then(t => console.error('Patch error:', t))).catch(e => console.error('Patch exception:', e)); 
}

function formatHours(ms) { return Math.floor(ms/3600000) + 'h ' + Math.floor((ms%3600000)/60000) + 'm'; }
function formatDuration(ms) { return Math.floor(ms/3600000) + 'h ' + Math.floor((ms%3600000)/60000) + 'm'; }
function formatDate(d) { return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}); }
function formatTime(d) { return new Date(d).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}); }
function calcHoursMs(entries) { return entries.reduce((sum, e) => { if(e.clock_out && !e.is_break) return sum + (new Date(e.clock_out)-new Date(e.clock_in)); return sum; }, 0); }
  </script>
</body>
</html>
<!-- redeploy -->
<!-- fix -->
